define("common/ui/search/search",["common/ui/popup_base/popup_base","css!common/ui/search/search.css","css!common/ui/list/list.css"],function(a){var b;var c,d,e={};var f,g,h,i={};var j=700,k=300;var l={baseHTML:function(){return['<div class="qui-search_bar"><form id="qui-search_form">','<a class="qui-search_backBtn"><span class="qui-icon _back"></span></a>','<input class="qui-search_input" type="text" placeholder="搜索" />','<a class="qui-search_goBtn">搜索</a>','<a class="qui-search_clear"><span class="qui-icon _close"></span></a>',"</form></div>",'<div class="qui-search_content"></div>'].join("")},baseEvent:function(){var e=$(a.getContent());f=e.find("input.qui-search_input");g=e.find(".qui-search_clear");h=e.find(".qui-search_content");e.find(".qui-search_backBtn").on(qyerUtil.EVENT.CLICK,function(){n.hide()});if(c&&typeof b.doSearch=="function"){e.find(".qui-search_goBtn").on(qyerUtil.EVENT.CLICK,function(){b.doSearch(f.val());n.hide()})}f.on("input",function(){if($(this).val()!=""){g.show();clearTimeout(d);var a=(new Date).getTime();var b=$(this).val();if(a-window.qyerUtil.latestSearchRequest<j){d=setTimeout(function(){m.getResult(a,b,"true")},k)}else{m.getResult(a,b,"false")}}else{g.hide()}});g.on(qyerUtil.EVENT.CLICK,function(){m.reset()});e.find("#qui-search_form").on("submit",function(a){a.preventDefault();a.stopPropagation();if(c){b.doSearch(f.val());n.hide()}else{f.blur()}})},listHTML:function(a){var b=['<ul class="qui-list qui-list_default',!a.html&&!a.template?" qui-list_"+(a.listType||"default_li"):"",'">'].join("");var c="</ul>";var d=[];for(var e=0,f=a.data.length;e<f;e++){var g=['<li data-quilistkey="',a.data[e].key||e,'"',' data-quilistindex="',e,'"',a.data[e].ipg?' data-bn-ipg="'+a.data[e].ipg+'"':"",">"].join(""),i,j="</li>";try{i=a.html?a.data[e].val:a.template?window.qyerUtil.renderTemplate(a.template,a.data[e]):a.data[e].val}catch(k){}d.push([g,i||"",j].join(""))}h.html([b,d.join(""),c].join(""))},listEvent:function(a){h.find(".qui-list").delegate("li",qyerUtil.EVENT.CLICK,function(){if(typeof a.onSelect=="function"){var c=$(this).attr("data-quilistkey");a.onSelect({key:$(this).attr("data-quilistkey"),index:$(this).attr("data-quilistindex"),data:a.data[$(this).attr("data-quilistindex")],el:$(this),"default":function(){b.doSearch(c)}});n.hide()}else{b.doSearch($(this).attr("data-quilistkey"));n.hide()}})},afterList:function(a){if(!a)return;if(a.afterListHTML){h.append('<div class="qui-search_afterList"></div>');h.find(".qui-search_afterList").append(typeof a.afterListHTML==="function"?a.afterListHTML(f.val()):window.qyerUtil.renderTemplate(a.afterListHTML,{val:f.val()}))}if(typeof a.onSelect==="function"){h.find(".qui-search_afterList").on(window.qyerUtil.EVENT.CLICK,function(){a.onSelect(f.val());n.hide()})}},msg:function(a){var b;if(typeof a=="object"&&"xhr"in a&&"type"in a){switch(a.type){case"error":case"parseerror":b=this.msgText.serverError;break;case"timeout":case"abort":default:b=this.msgText.connectionError}}else{b=a.toString()}h.html(['<p class="qui-search_msg">',b,"</p>"].join(""))},msgText:{noResult:"没有匹配的结果",serverError:"未能获得结果",connectionError:"网络或服务器连接错误"}};var m={reset:function(){f.val("");g.hide();if(b.standbyList){l.listHTML(b.standbyList);l.listEvent(b.standbyList)}else{h.html("")}},setOption:function(a){b.resultList=a.resultList||{};b.doSearch=typeof a.doSearch=="function"?a.doSearch:function(a){};b.noResultText=l.msgText.noResult;var d={type:function(){if(c){$(".qui-search_bar").addClass("qui-search_isSearch");$(".qui-search_input").attr("type","search");$(".qui-search_clear").addClass("isSearch");$(".qui-search_goBtn").show()}},backBtnIpg:function(){$("a.qui-search_backBtn").attr("data-bn-ipg",a.backBtnIpg)},goBtnText:function(){$(".qui-search_goBtn").html(a.goBtnText)},goBtnIpg:function(){$(".qui-search_goBtn").attr("data-bn-ipg",a.goBtnIpg)},noResultText:function(){b.noResultText=a.noResultText}};for(prop in a){if(d[prop])d[prop]()}if(!c){$(".qui-search_goBtn").hide()}},presentResult:function(a){var c=typeof b.mountData==="function"?b.mountData(a):a;if(c.result=="ok"){if(c.data.length==0){l.msg(b.noResultText)}else{var d=b.resultList;d.data=c.data;l.listHTML(d);l.listEvent(d)}l.afterList(b.afterList)}else{l.msg(c.data)}},getResult:function(a,c,d){window.qyerUtil.latestSearchRequest=a;if(c in e){m.presentResult(e[c]);return true}if(b.getAjaxData){try{$.getJSON(typeof b.getAjaxData==="function"?b.getAjaxData(c):qyerUtil.renderTemplate(b.getAjaxData,{val:c}),function(b,d,f){if(window.qyerUtil.latestSearchRequest!=a){return"timeout"}else{window.qyerUtil.activeSearchAjax=-1}if(b){e[c]=b;m.presentResult(b)}else{l.msg({xhr:f,type:d})}})}catch(f){console.log(f);l.msg(l.msgText.connectionError)}return true}else if(typeof b.getLocalData=="function"){var g=b.getLocalData.call(this,c);e[c]=g;m.presentResult(g);return true}}};var n={show:function(d){b=d;c="type"in b&&b.type=="search";a.show({type:1,contentHTML:l.baseHTML(),immediateEvent:function(a){$(a).find("input.qui-search_input").focus()},onShow:function(){m.setOption(d);l.baseEvent();m.reset();if(typeof d.onShow==="function"){d.onShow()}},onHide:b.onHide})},hide:function(){e={};clearTimeout(d);a.hide()},getQuery:function(){return f.val()}};return n});